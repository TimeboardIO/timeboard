<!DOCTYPE html>

<html layout:decorate="~{layouts/general.html(path='/timesheet')}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<body>

<div layout:fragment="content">

    <script>

        const update = function(date){
            const reducer = (accumulator, currentValue) => accumulator + currentValue;
            var data = $('[data-day="'+date+'"]').map(function(){return parseFloat($(this).val())}).get();
            var sum = data.reduce(reducer).toFixed(2);

            if(sum === '1.00'){
                $('[day-badge="'+date+'"]').addClass('green');
            }else{
                $('[day-badge="'+date+'"]').removeClass('green');
            }

            if(sum === '0.00'){
                $('[day-badge="'+date+'"]').addClass('red');
            }else{
                $('[day-badge="'+date+'"]').removeClass('red');
            }

            $('[day-badge="'+date+'"]').text(sum);
        }

    </script>

    <div class="timesheet-navigation-controls">
        <a th:href="@{/timesheet(week=${week-1}, year=${year})}" class="ui labeled icon button">
            <i class="left arrow icon"></i>Previous week</a>

        <span class="ui blue circular label bug">Week [[${week}]]</span>


        <a th:href="@{/timesheet(week=${week+1}, year=${year})}" class="ui right labeled icon button">
            <i class="right arrow icon"></i>Next week</a>
    </div>

    <form class="ui form" enctype="application/x-www-form-urlencoded" method="post">

        <table class="ui celled table" style="text-align:center">
            <thead>
            <tr>
                <th class="two wide">Project</th>
                <th class="two wide">Task</th>
                <th class="wide one" th:each="dw : ${dateWrappers}" style="text-align:center">
                    <div>[[${dw.day}]]</div>
                    <div class="grey header">[[${#dates.format(dw.date, 'dd/MM/yyyy')}]]</div>
                    <div style="margin-top: 5px;" th:day-badge="${#dates.format(dw.date, 'yyyy-MM-dd')}" class="ui circular label large">1</div>
                </th>
                <th class="wide one">ES</th>
                <th class="wide one">EL</th>
                <th class="wide one">RE</th>
                <th class="wide one">OE</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="ptask : ${projectTasks}">
                <tr  th:each="task : ${ptask.tasks}">
                    <td th:text="${ptask.project.name}"></td>
                    <td th:text="${task.name}"></td>
                    <td th:each="dw: ${dateWrappers}">
                        <input
                               type="number"
                               min="0" max="1" step="0.1"
                               th:if="${task.isOpen(dw.date)}"
                               th:value="${task.findTaskImputationValueByDate(dw.date)}"
                               th:data-task="${task.id}"
                               th:data-day="${#dates.format(dw.date, 'yyyy-MM-dd')}"
                               th:name="'task['+${task.id}+']day['+${#dates.format(dw.date, 'dd/MM/yyyy')}+']'" />
                    </td>
                    <td>
                        4
                    </td>
                    <td><input value="0" type="number"/></td>
                    <td><input value="0" type="number"/></td>
                    <td th:text="${task.estimateWork}"></td>
                </tr>
            </th:block>
            </tbody>
        </table>

        <div class="timesheet-validation-controls">
            <input type="submit" th:href="@{/timesheet(week=${week-1}, year=${year})}" class="ui  positive basic  button" value="Save My Week">
        </div>

     </form>

        <script>

            $("input[data-task]").keyup(function(){
                update($(this).attr('data-day'));
            });

            $("input[data-task]").keypress(function(){
                update($(this).attr('data-day'));
            });

            $("input[data-task]").focusout(function(){
                update($(this).attr('data-day'));
            });


        </script>


        <th:block th:each="day: ${days}">
            <script>
            update('[(${#dates.format(day.date, 'yyyy-MM-dd')})]');
            </script>
        </th:block>





</div>

</body>
</html>