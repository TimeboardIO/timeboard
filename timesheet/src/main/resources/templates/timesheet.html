<!DOCTYPE html>

<html layout:decorate="~{layouts/general.html(path='/timesheet')}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<body>

<div layout:fragment="content">

    <script>

        const updateBadge = function(date){
            const reducer = (accumulator, currentValue) => accumulator + currentValue;
            var data = $('[data-day="'+date+'"]').map(function(){return parseFloat($(this).val())}).get();

            var sum = 0;

            if(data.length > 0){
                sum = data.reduce(reducer);
            }

            if(sum === 1.00){
                $('[day-badge="'+date+'"]').addClass('green');
            }else{
                $('[day-badge="'+date+'"]').removeClass('green');
            }

            if(sum === 0.00){
                $('[day-badge="'+date+'"]').addClass('red');
            }else{
                $('[day-badge="'+date+'"]').removeClass('red');
            }

            $('[day-badge="'+date+'"]').text(sum.toFixed(2));
        }

        const update = function(date, task, type, val){

            $(".ui.dimmer").addClass("active");

            $.post("/timesheet", {
                'type':type,
                'day':date,
                'task':task,
                'imputation':val
            }).then(function(updateTask){
                $('[data-task-rew='+updateTask.taskID+']').text(updateTask.reEstimateWork);
                $('[data-task-es='+updateTask.taskID+']').text(updateTask.effortSpent);
                $('[data-task-ew='+updateTask.taskID+']').text(updateTask.estimateWork);
                $('[data-task-rtbd='+updateTask.taskID+']').val(parseFloat(updateTask.remainToBeDone.replace(',','.')));
                updateBadge(date);
                $(".ui.dimmer").removeClass("active");
            });
        }


    </script>

    <div class="timesheet-navigation-controls">
        <a class="ui labeled icon button" th:href="@{/timesheet(week=${week-1}, year=${year})}">
            <i class="left arrow icon"></i>Previous week</a>

        <span class="ui blue circular label bug">Week [[${week}]]</span>


        <a class="ui right labeled icon button" th:href="@{/timesheet(week=${week+1}, year=${year})}">
            <i class="right arrow icon"></i>Next week</a>
    </div>

    <div class="ui inverted dimmer">
        <div class="ui loader"></div>
    </div>

    <form class="ui form" enctype="application/x-www-form-urlencoded" method="post">

        <table class="ui celled table" style="text-align:center">
            <thead>
            <tr>
                <th class="two wide">Task</th>
                <th class="wide one" style="text-align:center" th:each="dw : ${dateWrappers}">
                    <div>[[${dw.day}]]</div>
                    <div class="grey header">[[${#dates.format(dw.date, 'dd/MM/yyyy')}]]</div>
                    <div class="ui circular label large" style="margin-top: 5px;"
                         th:day-badge="${#dates.format(dw.date, 'yyyy-MM-dd')}">-
                    </div>
                </th>
                <th class="wide one">Effort spent</th>
                <th class="wide one">Remain To Be Done</th>
                <th class="wide one">Original estimate</th>
                <th class="wide one">Restimate</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="ptask : ${projectTasks}">
                <tr>
                    <td class="ui header left aligned green small" colspan="12" th:text="${ptask.project.name}"></td>
                </tr>
                <tr th:each="task : ${ptask.tasks}">
                    <td th:text="${task.name}"></td>
                    <td th:each="dw: ${dateWrappers}">
                        <input
                                max="1"
                                min="0"
                                step="0.1"
                                th:data-day="${#dates.format(dw.date, 'yyyy-MM-dd')}"
                                th:data-task="${task.id}"
                                th:if="${task.isOpen(dw.date)}"
                                th:name="'task['+${task.id}+']day['+${#dates.format(dw.date, 'dd/MM/yyyy')}+']'"
                                th:value="${task.findTaskImputationValueByDate(dw.date)}"
                                type="number"/>
                    </td>
                    <td th:data-task-es="${task.id}" th:text="${#numbers.formatDecimal(task.getEffortSpent(), 1, 'COMMA', 2, 'POINT')}"></td>
                    <td><input
                            min="0"
                            step="0.1"
                            name="remainsToBeDone"
                            th:value="${task.getRemainsToBeDone()}"
                            th:data-task-rtbd="${task.id}"
                            type="number"
                    /></td>
                    <td th:data-task-ew="${task.id}" th:text="${task.estimateWork}"></td>
                    <td
                            th:data-task-rew="${task.id}"
                            th:text="${#numbers.formatDecimal(task.getReEstimateWork(), 1, 'COMMA', 2, 'POINT')}"
                            th:classappend="${task.getReEstimateWork() > task.estimateWork}   ? 'negative':''"
                    ></td>
                </tr>
            </th:block>
            </tbody>
        </table>

        <div class="timesheet-validation-controls">
            <input class="ui  positive basic  button" th:href="@{/timesheet(week=${week-1}, year=${year})}"
                   type="submit" value="Validate My Week">
        </div>

    </form>

    <script>

            $("input[data-task]").on('input',function(){
                update($(this).attr('data-day'), $(this).attr('data-task'), 'imputation',$(this).val());
            });

            $("input[data-task-rtbd]").on('input',function(){
                update(null, $(this).attr('data-task-rtbd'), 'rtbd', $(this).val());
            });

    </script>


    <th:block th:each="dw : ${dateWrappers}">
        <script>
            updateBadge('[(${#dates.format(dw.date, 'yyyy-MM-dd')})]');
        </script>
    </th:block>


</div>

</body>
</html>