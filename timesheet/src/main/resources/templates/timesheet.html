<!DOCTYPE html>

<html layout:decorate="~{layouts/general.html(path='/timesheet')}"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:th="http://www.thymeleaf.org">

<body>

<div layout:fragment="content">

    <script>

        const updateBadge = function(date){
            const reducer = (accumulator, currentValue) => accumulator + currentValue;
            var data = $('[data-day="'+date+'"]').map(function(){return parseFloat($(this).val())}).get();
            var sum = data.reduce(reducer);


            if(sum === 1.00){
                $('[day-badge="'+date+'"]').addClass('green');
            }else{
                $('[day-badge="'+date+'"]').removeClass('green');
            }

            if(sum === 0.00){
                $('[day-badge="'+date+'"]').addClass('red');
            }else{
                $('[day-badge="'+date+'"]').removeClass('red');
            }

            $('[day-badge="'+date+'"]').text(sum.toFixed(2));
        }

        const update = function(date, task, val){

            $.post("/timesheet", {
                'day':date,
                'task':task,
                'imputation':val
            }).then(function(){
                updateBadge(date);
            });
        }


    </script>

    <div class="timesheet-navigation-controls">
        <a class="ui labeled icon button" th:href="@{/timesheet(week=${week-1}, year=${year})}">
            <i class="left arrow icon"></i>Previous week</a>

        <span class="ui blue circular label bug">Week [[${week}]]</span>


        <a class="ui right labeled icon button" th:href="@{/timesheet(week=${week+1}, year=${year})}">
            <i class="right arrow icon"></i>Next week</a>
    </div>

    <form class="ui form" enctype="application/x-www-form-urlencoded" method="post">

        <table class="ui celled table" style="text-align:center">
            <thead>
            <tr>
                <th class="two wide">Task</th>
                <th class="wide one" style="text-align:center" th:each="dw : ${dateWrappers}">
                    <div>[[${dw.day}]]</div>
                    <div class="grey header">[[${#dates.format(dw.date, 'dd/MM/yyyy')}]]</div>
                    <div class="ui circular label large" style="margin-top: 5px;"
                         th:day-badge="${#dates.format(dw.date, 'yyyy-MM-dd')}">-
                    </div>
                </th>
                <th class="wide one">ES</th>
                <th class="wide one">EL</th>
                <th class="wide one">RE</th>
                <th class="wide one">OE</th>
            </tr>
            </thead>
            <tbody>
            <th:block th:each="ptask : ${projectTasks}">
                <tr>
                    <td class="ui header left aligned green small" colspan="12" th:text="${ptask.project.name}"></td>
                </tr>
                <tr th:each="task : ${ptask.tasks}">
                    <td th:text="${task.name}"></td>
                    <td th:each="dw: ${dateWrappers}">
                        <input
                                max="1"
                                min="0" step="0.1" th:data-day="${#dates.format(dw.date, 'yyyy-MM-dd')}"
                                th:data-task="${task.id}"
                                th:if="${task.isOpen(dw.date)}"
                                th:name="'task['+${task.id}+']day['+${#dates.format(dw.date, 'dd/MM/yyyy')}+']'"
                                th:value="${task.findTaskImputationValueByDate(dw.date)}"
                                type="number"/>
                    </td>
                    <td th:text="${#numbers.formatDecimal(task.getEffortSpent(),0, 'COMMA', 2, 'POINT')}"></td>
                    <td><input type="number" value="0"/></td>
                    <td><input type="number" value="0"/></td>
                    <td th:text="${task.estimateWork}"></td>
                </tr>
            </th:block>
            </tbody>
        </table>

        <div class="timesheet-validation-controls">
            <input class="ui  positive basic  button" th:href="@{/timesheet(week=${week-1}, year=${year})}"
                   type="submit" value="Save My Week">
        </div>

    </form>

    <script>


            $("input[data-task]").on('input',function(){
                update($(this).attr('data-day'), $(this).attr('data-task'), $(this).val());
            });



    </script>


    <th:block th:each="dw : ${dateWrappers}">
        <script>
            updateBadge('[(${#dates.format(dw.date, 'yyyy-MM-dd')})]');

        </script>
    </th:block>


</div>

</body>
</html>